import re
from PIL import Image
import pytesseract
import docx

def extract_text_from_image(image_path):
    image = Image.open(image_path)
    raw_text = pytesseract.image_to_string(image)
    return raw_text

def clean_vtt_text(raw_text):
    cleaned_lines = []
    for line in raw_text.splitlines():
        if re.match(r"^\s*$", line):  # skip empty lines
            continue
        if re.match(r"^\d{2}:\d{2}:\d{2}\.\d{3} -->", line):  # skip timestamps
            continue
        if re.match(r"^[\w-]{36}", line.strip()):  # skip UUID lines
            continue
        cleaned_lines.append(line.strip())
    return ' '.join(cleaned_lines)

def save_to_doc_and_txt(text, docx_filename, txt_filename):
    # Save to DOCX
    doc = docx.Document()
    doc.add_paragraph(text)
    doc.save(docx_filename)

    # Save to TXT
    with open(txt_filename, "w", encoding="utf-8") as f:
        f.write(text)

# Define file paths
image_path = "/mnt/data/IMG_6B9B82AF-7D01-43FE-9919-537B2ABB8E9F.jpeg"
docx_path = "/mnt/data/Extracted_Transcript.docx"
txt_path = "/mnt/data/Extracted_Transcript.txt"

# Run the steps
raw_text = extract_text_from_image(image_path)
final_text = clean_vtt_text(raw_text)
save_to_doc_and_txt(final_text, docx_path, txt_path)

print("Extraction and file save complete.")