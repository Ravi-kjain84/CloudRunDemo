import win32com.client
import time

outlook = win32com.client.Dispatch("Outlook.Application")
namespace = outlook.GetNamespace("MAPI")

visited = set()
org_chart = []

def get_manager(employee_email):
    try:
        recipient = namespace.CreateRecipient(employee_email)
        user = recipient.AddressEntry.GetExchangeUser()
        if user is None:
            return None
        manager = user.Manager
        if manager:
            return manager.PrimarySmtpAddress
    except Exception as e:
        print(f"Error processing {employee_email}: {e}")
        return None

def crawl_org(email):
    if email in visited:
        return
    visited.add(email)
    
    manager_email = get_manager(email)
    if manager_email:
        org_chart.append((email, manager_email))
        crawl_org(manager_email)  # Go upwards

# Starting point: e.g., CEO or known person in the chain
start_email = "rakesh.sharma@hsbc.co.in"
crawl_org(start_email)

# Save results
import pandas as pd
df = pd.DataFrame(org_chart, columns=["Employee", "Manager"])
df.to_excel("org_hierarchy_from_outlook.xlsx", index=False)

print("Hierarchy extraction complete.")