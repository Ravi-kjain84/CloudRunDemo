-- Step 1: Aggregate values from Dataset 1
WITH dataset1_agg AS (
  SELECT 
    RP.Post_CRM_PRA_Reporting_Approach AS reporting_approach,
    RP.Pre_CRM_Corep_Exposure_Class AS exposure_class,
    SUM(RP.RWA_Post_Supporting_Factor_USD) AS total_rwa_1,
    SUM(RP.Original_Exposure_Pre_CCF_USD) AS total_orig_exposure_1,
    SUM(RP.EAD_USD) AS total_ead_1
  FROM `hsbc-finance-data.ROHBMECOMBINEDRRoHBME01FOTCRWACALCFIRSTUNADJ20250327081914.FOTC_GRP_RWA_RP_OUTPUT` AS RP
  WHERE RP.PRA_Reporting_Approach_Flag = 'Y'
    AND RP.source = 'RWA_PC'
    AND RP.Interco_Flag = 'N'
    AND RP.NCCR_Flag = 'NCCR'
    AND RP.grca_entity_identifier IN ('4435', '4475')
  GROUP BY reporting_approach, exposure_class
),

-- Step 2: Aggregate values from Dataset 2
dataset2_agg AS (
  SELECT 
    RP.Post_CRM_PRA_Reporting_Approach AS reporting_approach,
    RP.Pre_CRM_Corep_Exposure_Class AS exposure_class,
    SUM(RP.RWA_Post_Supporting_Factor_USD) AS total_rwa_2,
    SUM(RP.Original_Exposure_Pre_CCF_USD) AS total_orig_exposure_2,
    SUM(RP.EAD_USD) AS total_ead_2
  FROM `hsbc-finance-data.ROHBMECOMBINEDRRoHBME01FOTCRWACALCFIRSTUNADJ20250310084144.FOTC_GRP_RWA_RP_OUTPUT` AS RP
  WHERE RP.PRA_Reporting_Approach_Flag = 'Y'
    AND RP.source = 'RWA_PC'
    AND RP.Interco_Flag = 'N'
    AND RP.NCCR_Flag = 'NCCR'
    AND RP.grca_entity_identifier IN ('4435', '4475')
  GROUP BY reporting_approach, exposure_class
),

-- Step 3: Compare and label mismatches with % difference
mismatches AS (
  SELECT 
    COALESCE(d1.reporting_approach, d2.reporting_approach) AS reporting_approach,
    COALESCE(d1.exposure_class, d2.exposure_class) AS exposure_class,
    NULL AS customer_group,
    d1.total_rwa_1,
    d2.total_rwa_2,
    d1.total_orig_exposure_1,
    d2.total_orig_exposure_2,
    d1.total_ead_1,
    d2.total_ead_2,

    SAFE_DIVIDE(ABS(d1.total_rwa_1 - d2.total_rwa_2), NULLIF(d1.total_rwa_1, 0)) * 100 AS rwa_diff_pct,
    SAFE_DIVIDE(ABS(d1.total_orig_exposure_1 - d2.total_orig_exposure_2), NULLIF(d1.total_orig_exposure_1, 0)) * 100 AS orig_exp_diff_pct,
    SAFE_DIVIDE(ABS(d1.total_ead_1 - d2.total_ead_2), NULLIF(d1.total_ead_1, 0)) * 100 AS ead_diff_pct,

    CASE
      WHEN d1.reporting_approach IS NULL THEN 'Missing in Dataset 1'
      WHEN d2.reporting_approach IS NULL THEN 'Missing in Dataset 2'
      ELSE
        TRIM(
          CONCAT(
            IF(d1.total_rwa_1 != d2.total_rwa_2, 'RWA Mismatch', ''),
            IF(d1.total_orig_exposure_1 != d2.total_orig_exposure_2,
              IF(d1.total_rwa_1 != d2.total_rwa_2, ' + Original Exposure Mismatch', 'Original Exposure Mismatch'), ''),
            IF(d1.total_ead_1 != d2.total_ead_2,
              IF(d1.total_rwa_1 != d2.total_rwa_2 OR d1.total_orig_exposure_1 != d2.total_orig_exposure_2,
                ' + EAD Mismatch', 'EAD Mismatch'), '')
          )
        )
    END AS mismatch_type
  FROM dataset1_agg d1
  FULL OUTER JOIN dataset2_agg d2
    ON d1.reporting_approach = d2.reporting_approach
    AND d1.exposure_class = d2.exposure_class
  WHERE 
    IFNULL(d1.total_rwa_1, 0) != IFNULL(d2.total_rwa_2, 0)
    OR IFNULL(d1.total_orig_exposure_1, 0) != IFNULL(d2.total_orig_exposure_2, 0)
    OR IFNULL(d1.total_ead_1, 0) != IFNULL(d2.total_ead_2, 0)
),

-- Step 4: Drill down into customer_group for RWA mismatches
granular_compare AS (
  SELECT 
    d1.Post_CRM_PRA_Reporting_Approach AS reporting_approach,
    d1.Pre_CRM_Corep_Exposure_Class AS exposure_class,
    d1.customer_group,
    SUM(d1.RWA_Post_Supporting_Factor_USD) AS total_rwa_1,
    SUM(d2.RWA_Post_Supporting_Factor_USD) AS total_rwa_2,
    NULL AS total_orig_exposure_1,
    NULL AS total_orig_exposure_2,
    NULL AS total_ead_1,
    NULL AS total_ead_2,
    SAFE_DIVIDE(ABS(SUM(d1.RWA_Post_Supporting_Factor_USD) - SUM(d2.RWA_Post_Supporting_Factor_USD)), NULLIF(SUM(d1.RWA_Post_Supporting_Factor_USD), 0)) * 100 AS rwa_diff_pct,
    NULL AS orig_exp_diff_pct,
    NULL AS ead_diff_pct,
    'Customer Group Drill-Down' AS mismatch_type
  FROM `hsbc-finance-data.ROHBMECOMBINEDRRoHBME01FOTCRWACALCFIRSTUNADJ20250327081914.FOTC_GRP_RWA_RP_OUTPUT` d1
  JOIN `hsbc-finance-data.ROHBMECOMBINEDRRoHBME01FOTCRWACALCFIRSTUNADJ20250310084144.FOTC_GRP_RWA_RP_OUTPUT` d2
    ON d1.customer_group = d2.customer_group
    AND d1.Post_CRM_PRA_Reporting_Approach = d2.Post_CRM_PRA_Reporting_Approach
    AND d1.Pre_CRM_Corep_Exposure_Class = d2.Pre_CRM_Corep_Exposure_Class
  WHERE d1.PRA_Reporting_Approach_Flag = 'Y'
    AND d1.source = 'RWA_PC'
    AND d1.Interco_Flag = 'N'
    AND d1.NCCR_Flag = 'NCCR'
    AND d1.grca_entity_identifier IN ('4435', '4475')
    AND d2.PRA_Reporting_Approach_Flag = 'Y'
    AND d2.source = 'RWA_PC'
    AND d2.Interco_Flag = 'N'
    AND d2.NCCR_Flag = 'NCCR'
    AND d2.grca_entity_identifier IN ('4435', '4475')
    AND EXISTS (
      SELECT 1
      FROM mismatches m
      WHERE m.reporting_approach = d1.Post_CRM_PRA_Reporting_Approach
        AND m.exposure_class = d1.Pre_CRM_Corep_Exposure_Class
        AND m.mismatch_type LIKE '%RWA Mismatch%'
    )
  GROUP BY reporting_approach, exposure_class, customer_group
)

-- Step 5: Final output with thresholds and sorting
SELECT * 
FROM mismatches
WHERE rwa_diff_pct > 5 OR orig_exp_diff_pct > 5 OR ead_diff_pct > 5

UNION ALL

SELECT * 
FROM granular_compare
WHERE rwa_diff_pct > 5
ORDER BY rwa_diff_pct DESC

