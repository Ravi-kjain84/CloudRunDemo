-- Step D: Compute total RWA for reference (for % impact)
, total_rwa_context AS (
  SELECT 
    SUM(RWA_Post_Supporting_Factor_USD) AS total_rwa_selection
  FROM `hsbc-finance-data.ROHBMECOMBINEDRRoHBME01FOTCRWACALCFIRSTUNADJ20250327081914.FOTC_GRP_RWA_RP_OUTPUT`
  WHERE PRA_Reporting_Approach_Flag = 'Y'
    AND source = 'RWA_PC'
    AND Interco_Flag = 'N'
    AND NCCR_Flag = 'NCCR'
    AND grca_entity_identifier IN ('4435', '4475')
)

-- Step E: Granular Compare with diffs and % of total
, granular_compare AS (
  SELECT 
    d1.reporting_approach,
    d1.exposure_class,
    d1.customer_group,
    ROUND(d1.total_rwa_1, 2) AS total_rwa_1,
    ROUND(d2.total_rwa_2, 2) AS total_rwa_2,
    ROUND(d1.total_orig_exposure_1, 2) AS total_orig_exposure_1,
    ROUND(d2.total_orig_exposure_2, 2) AS total_orig_exposure_2,
    ROUND(d1.total_ead_1, 2) AS total_ead_1,
    ROUND(d2.total_ead_2, 2) AS total_ead_2,

    -- Absolute differences
    ROUND(d1.total_rwa_1 - d2.total_rwa_2, 2) AS rwa_diff,
    ROUND(d1.total_orig_exposure_1 - d2.total_orig_exposure_2, 2) AS orig_exp_diff,
    ROUND(d1.total_ead_1 - d2.total_ead_2, 2) AS ead_diff,

    -- % differences row-level
    ROUND(SAFE_DIVIDE(ABS(d1.total_rwa_1 - d2.total_rwa_2), NULLIF(d1.total_rwa_1, 0)) * 100, 2) AS rwa_diff_pct,
    ROUND(SAFE_DIVIDE(ABS(d1.total_orig_exposure_1 - d2.total_orig_exposure_2), NULLIF(d1.total_orig_exposure_1, 0)) * 100, 2) AS orig_exp_diff_pct,
    ROUND(SAFE_DIVIDE(ABS(d1.total_ead_1 - d2.total_ead_2), NULLIF(d1.total_ead_1, 0)) * 100, 2) AS ead_diff_pct,

    -- % impact on total RWA
    ROUND(SAFE_DIVIDE(ABS(d1.total_rwa_1 - d2.total_rwa_2), NULLIF(t.total_rwa_selection, 0)) * 100, 2) AS rwa_impact_on_total_pct,

    'Customer Group Drill-Down' AS mismatch_type

  FROM dataset1_grouped d1
  JOIN dataset2_grouped d2
    ON d1.reporting_approach = d2.reporting_approach
    AND d1.exposure_class = d2.exposure_class
    AND d1.customer_group = d2.customer_group
  JOIN (
    SELECT DISTINCT reporting_approach, exposure_class
    FROM mismatches
  ) mismatch_keys
    ON d1.reporting_approach = mismatch_keys.reporting_approach
    AND d1.exposure_class = mismatch_keys.exposure_class
  CROSS JOIN total_rwa_context t
)
