-- Step 1: Aggregate RWA, Original Exposure, EAD
WITH dataset1_agg AS (
  SELECT 
    RP.Post_CRM_PRA_Reporting_Approach AS reporting_approach,
    RP.Pre_CRM_Corep_Exposure_Class AS exposure_class,
    SUM(RP.RWA_Post_Supporting_Factor_USD) AS total_rwa_1,
    SUM(RP.Original_Exposure_Pre_CCF_USD) AS total_orig_exposure_1,
    SUM(RP.EAD_USD) AS total_ead_1
  FROM `ROHBMECOMBINEDRRoHBME01FOTCRWACALCFIRSTUNADJ20250327081914.FOTC_GRP_RWA_RP_OUTPUT` AS RP
  WHERE RP.PRA_Reporting_Approach_Flag = 'Y'
    AND RP.source = 'RWA_PC'
    AND RP.Interco_Flag = 'N'
    AND RP.NCCR_Flag = 'N'
    AND RP.grca_entity_identifier IN ('4435', '4475')
  GROUP BY reporting_approach, exposure_class
),

dataset2_agg AS (
  SELECT 
    RP.Post_CRM_PRA_Reporting_Approach AS reporting_approach,
    RP.Pre_CRM_Corep_Exposure_Class AS exposure_class,
    SUM(RP.RWA_Post_Supporting_Factor_USD) AS total_rwa_2,
    SUM(RP.Original_Exposure_Pre_CCF_USD) AS total_orig_exposure_2,
    SUM(RP.EAD_USD) AS total_ead_2
  FROM `ROHBMECOMBINEDRRoHBME01FOTCRWACALCFIRSTUNADJ20250310084144.FOTC_GRP_RWA_RP_OUTPUT` AS RP
  WHERE RP.PRA_Reporting_Approach_Flag = 'Y'
    AND RP.source = 'RWA_PC'
    AND RP.Interco_Flag = 'N'
    AND RP.NCCR_Flag = 'N'
    AND RP.grca_entity_identifier IN ('4435', '4475')
  GROUP BY reporting_approach, exposure_class
),

-- Step 2: Flag mismatches across RWA, EAD, and Original Exposure
mismatches AS (
  SELECT 
    COALESCE(d1.reporting_approach, d2.reporting_approach) AS reporting_approach,
    COALESCE(d1.exposure_class, d2.exposure_class) AS exposure_class,
    d1.total_rwa_1,
    d2.total_rwa_2,
    d1.total_orig_exposure_1,
    d2.total_orig_exposure_2,
    d1.total_ead_1,
    d2.total_ead_2,
    CASE
      WHEN d1.reporting_approach IS NULL THEN 'Missing in Dataset 1'
      WHEN d2.reporting_approach IS NULL THEN 'Missing in Dataset 2'
      ELSE CONCAT_WS(' + ',
        IF(d1.total_rwa_1 != d2.total_rwa_2, 'RWA Mismatch', NULL),
        IF(d1.total_orig_exposure_1 != d2.total_orig_exposure_2, 'Original Exposure Mismatch', NULL),
        IF(d1.total_ead_1 != d2.total_ead_2, 'EAD Mismatch', NULL)
      )
    END AS mismatch_type
  FROM dataset1_agg d1
  FULL OUTER JOIN dataset2_agg d2
    ON d1.reporting_approach = d2.reporting_approach
    AND d1.exposure_class = d2.exposure_class
  WHERE 
    IFNULL(d1.total_rwa_1, 0) != IFNULL(d2.total_rwa_2, 0)
    OR IFNULL(d1.total_orig_exposure_1, 0) != IFNULL(d2.total_orig_exposure_2, 0)
    OR IFNULL(d1.total_ead_1, 0) != IFNULL(d2.total_ead_2, 0)
),

-- Step 3: Drill-down for RWA mismatches at customer group level
granular_compare AS (
  SELECT 
    d1.Post_CRM_PRA_Reporting_Approach AS reporting_approach,
    d1.Pre_CRM_Corep_Exposure_Class AS exposure_class,
    d1.customer_group,
    SUM(d1.RWA_Post_Supporting_Factor_USD) AS rwa_1,
    SUM(d2.RWA_Post_Supporting_Factor_USD) AS rwa_2
  FROM `ROHBMECOMBINEDRRoHBME01FOTCRWACALCFIRSTUNADJ20250327081914.FOTC_GRP_RWA_RP_OUTPUT` d1
  JOIN `ROHBMECOMBINEDRRoHBME01FOTCRWACALCFIRSTUNADJ20250310084144.FOTC_GRP_RWA_RP_OUTPUT` d2
    ON d1.customer_group = d2.customer_group
    AND d1.Post_CRM_PRA_Reporting_Approach = d2.Post_CRM_PRA_Reporting_Approach
    AND d1.Pre_CRM_Corep_Exposure_Class = d2.Pre_CRM_Corep_Exposure_Class
  WHERE d1.PRA_Reporting_Approach_Flag = 'Y'
    AND d1.source = 'RWA_PC'
    AND d1.Interco_Flag = 'N'
    AND d1.NCCR_Flag = 'N'
    AND d1.grca_entity_identifier IN ('4435', '4475')
    AND d2.PRA_Reporting_Approach_Flag = 'Y'
    AND d2.source = 'RWA_PC'
    AND d2.Interco_Flag = 'N'
    AND d2.NCCR_Flag = 'N'
    AND d2.grca_entity_identifier IN ('4435', '4475')
    AND EXISTS (
      SELECT 1
      FROM mismatches m
      WHERE m.reporting_approach = d1.Post_CRM_PRA_Reporting_Approach
        AND m.exposure_class = d1.Pre_CRM_Corep_Exposure_Class
        AND m.mismatch_type LIKE '%RWA Mismatch%'
    )
  GROUP BY reporting_approach, exposure_class, customer_group
)

-- Step 4: Final Unified Output
SELECT * FROM mismatches

UNION ALL

SELECT 
  reporting_approach,
  exposure_class,
  customer_group,
  rwa_1 AS total_rwa_1,
  rwa_2 AS total_rwa_2,
  'Customer Group Drill-Down' AS mismatch_type
FROM granular_compare
WHERE rwa_1 != rwa_2

